<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>برنامج الحفظ اليومي للقرآن</title>
  <!-- Tailwind CDN (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: {} } };
  </script>
  <style>
    .sr-only { position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0; }
    .tabular-nums { font-variant-numeric: tabular-nums; }
    .row-animated {
      transition: background 0.3s, border-color 0.3s, transform 0.3s;
      animation: scaleUpFade 0.4s;
    }
    @keyframes scaleUpFade {
      0%   { transform: scale(0.97); opacity: 0.7;}
      60%  { transform: scale(1.05); opacity: 1;}
      100% { transform: scale(1); opacity: 1;}
    }
    /* Custom scrollbar for cards */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: #c9a22744; border-radius: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body>
  <div class="hidden
    bg-[#FAFAFA] text-[#222] border-[#E0E0E0] bg-white
    bg-[#18181B] text-[#EEE] border-[#444] bg-[#23232A]
    bg-green-50 border-green-400 text-green-900 bg-green-100
    bg-emerald-700/30 border-emerald-400 text-emerald-100
    bg-green-200 text-green-900
    bg-white border-gray-200 text-gray-800
    bg-[#23232A] border-[#444] text-[#EEE]
    border-green-400 text-green-500
    border-emerald-400 text-emerald-400
    hover:bg-[#F0F0F0] hover:bg-[#333]
    bg-gradient-to-br from-green-100 via-emerald-100 to-yellow-50
    bg-gradient-to-br from-blue-100 via-indigo-100 to-yellow-50
    border-[#bfa850] text-[#0f2e1f]
    border-[#3d7f9e] text-[#233d6b]
    bg-[#FAF7EC] text-[#0f2e1f]
    bg-[#EAF7E9] text-[#0f2e1f]
    bg-[#DFF1E0] text-[#0f2e1f]
    bg-[#f6eeb7] text-[#9d7d28]
    bg-[#e1eaff] text-[#233d6b]
  "></div>

  <div id="app" class="min-h-screen w-full"></div>

  <script>
    // ===================== Constants =====================
    const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
    const wrap604 = (n) => (((n - 1) % 604) + 604) % 604 + 1;
    const JUZ_START_PAGES = [1,22,42,62,82,102,121,142,162,182,201,222,242,262,282,302,322,342,362,382,402,422,442,462,482,502,522,542,562,582];
    const juzSpan = (j) => {
      const start = JUZ_START_PAGES[j - 1];
      const end = j === 30 ? 604 : JUZ_START_PAGES[j] - 1;
      return { start, end };
    };
    const SAB7 = ["السجدة","يس","الدخان","الواقعة","الملك","الإنسان","البروج"];
    const DEFAULT_READS_FOR_PREP = 10;

    // ===================== Themes =====================
    function themeClasses(theme) {
      switch (theme) {
        case "green-gold":
          return {
            page: "bg-gradient-to-br from-green-100 via-emerald-100 to-yellow-50 text-[#0f2e1f]",
            card: "bg-[#FAF7EC] border-[#bfa850] text-[#0f2e1f]",
            input: "bg-white text-[#0f2e1f] border-[#bfa850]",
            button: "border-[#bfa850] hover:bg-[#f6eeb7]",
            rowDone: "bg-[#EAF7E9] border-green-500 text-green-900 row-animated",
            rowActive: "bg-white border-[#bfa850] text-[#0f2e1f]",
            chipOn: "bg-[#DFF1E0] text-[#0f2e1f] border-green-500",
            checkIcon: "text-green-500",
            resetBtn: "bg-green-100 border-green-500 text-green-900 hover:bg-green-200",
            select: "border-[#bfa850] bg-white text-[#0f2e1f]",
          };
        case "blue-gold":
          return {
            page: "bg-gradient-to-br from-blue-100 via-indigo-100 to-yellow-50 text-[#233d6b]",
            card: "bg-[#e1eaff] border-[#3d7f9e] text-[#233d6b]",
            input: "bg-white text-[#233d6b] border-[#3d7f9e]",
            button: "border-[#3d7f9e] hover:bg-[#e1eaff]",
            rowDone: "bg-[#e1eaff] border-indigo-500 text-indigo-900 row-animated",
            rowActive: "bg-white border-[#3d7f9e] text-[#233d6b]",
            chipOn: "bg-indigo-100 text-indigo-900 border-indigo-500",
            checkIcon: "text-indigo-500",
            resetBtn: "bg-blue-100 border-indigo-500 text-indigo-900 hover:bg-blue-200",
            select: "border-[#3d7f9e] bg-white text-[#233d6b]",
          };
        case "dark":
          return {
            page: "bg-[#18181B] text-[#EEE]",
            card: "border-[#444] bg-[#23232A]",
            input: "bg-[#23232A] text-[#EEE] border-[#444]",
            button: "border-[#444] hover:bg-[#333]",
            rowDone: "bg-emerald-700/30 border-emerald-400 text-emerald-100 row-animated",
            rowActive: "bg-[#23232A] border-[#444] text-[#EEE]",
            chipOn: "bg-emerald-700 text-emerald-100 border-emerald-400",
            checkIcon: "text-emerald-400",
            resetBtn: "bg-[#23232A] border-emerald-400 text-emerald-100 hover:bg-[#18181B]",
            select: "border-[#444] bg-[#23232A] text-[#EEE]",
          };
        default: // light
          return {
            page: "bg-[#FAFAFA] text-[#222]",
            card: "border-[#E0E0E0] bg-white",
            input: "bg-white text-[#222] border-[#E0E0E0]",
            button: "border-[#E0E0E0] hover:bg-[#F0F0F0]",
            rowDone: "bg-green-100 border-green-400 text-green-900 row-animated",
            rowActive: "bg-white border-gray-200 text-gray-800",
            chipOn: "bg-green-200 text-green-900 border-green-400",
            checkIcon: "text-green-500",
            resetBtn: "bg-gray-100 border-gray-400 text-gray-900 hover:bg-gray-200",
            select: "border-[#E0E0E0] bg-white text-[#222]",
          };
      }
    }

    // ===================== State =====================
    const state = {
      settings: { theme: "green-gold" }, // default theme
      todayPage: null, // 1..604
      day: {
        readJuz: { juz: null, done: false },
        memorizeToday: { done: false },
        reviewLast7: { done: false },
        prepNext7: { done: false },
        prepTomorrow: { count: 0, done: false },
        reviewRecent20: { done: false },
        reviewOldJuz: { juz: null, done: false },
        sabAlMunajiyat: { subs: {} }, // indices 0..6 true/false
      },
      _rowAnim: {},
    };

    // ===================== Derived Windows =====================
    function hasPage() {
      return Number.isInteger(state.todayPage) && state.todayPage >= 1 && state.todayPage <= 604;
    }
    function prev7() {
      if (!hasPage()) return [];
      return Array.from({length:7}, (_,i)=> wrap604(state.todayPage - 7 + i));
    }
    function next7() {
      if (!hasPage()) return [];
      return Array.from({length:7}, (_,i)=> wrap604(state.todayPage + 1 + i));
    }
    function tomorrowPage() {
      return hasPage() ? wrap604(state.todayPage + 1) : null;
    }
    function recent20() {
      if (!hasPage()) return [];
      return Array.from({length:20}, (_,i)=> wrap604(state.todayPage - 19 + i));
    }

    // ===================== Progress =====================
    function completionCounts() {
      const enabledTasks = [];
      const addTask = (id, count=1) => { enabledTasks.push({id, count}); };
      addTask("readJuz");
      addTask("memorizeToday");
      if (hasPage()) {
        addTask("reviewLast7");
        addTask("prepNext7");
        addTask("prepTomorrow");
        addTask("reviewRecent20");
      }
      addTask("reviewOldJuz");
      addTask("sabAlMunajiyat", 7);

      let total=0, done=0;
      for (const t of enabledTasks) {
        if (t.id === "sabAlMunajiyat") {
          total += 7;
          for (let i=0;i<7;i++) if (state.day.sabAlMunajiyat.subs[i]) done += 1;
        } else if (t.id === "prepTomorrow") {
          total += 1;
          done += (state.day.prepTomorrow.done || state.day.prepTomorrow.count >= DEFAULT_READS_FOR_PREP) ? 1 : 0;
        } else {
          total += 1;
          done += state.day[t.id].done ? 1 : 0;
        }
      }
      return { total, done, percent: total ? Math.round(done/total*100) : 0 };
    }

    // ===================== Render =====================
    const root = document.getElementById("app");
    function el(html) {
      const t = document.createElement("template");
      t.innerHTML = html.trim();
      return t.content.firstElementChild;
    }

    function render() {
      const t = themeClasses(state.settings.theme);
      const { total, done, percent } = completionCounts();

      root.className = `${t.page}`;
      root.innerHTML = `
        <div class="max-w-4xl mx-auto p-4 sm:p-6">
          <header class="flex items-center justify-between gap-3 mb-4">
            <div>
              <h1 class="text-2xl sm:text-3xl font-bold">برنامج الحفظ اليومي للقرآن</h1>
            </div>
            <div class="flex items-center gap-2">
              <select id="selTheme" class="px-3 py-2 rounded-xl ${t.select}">
                <option value="green-gold" ${state.settings.theme==="green-gold"?"selected":""}>أخضر وذهبي</option>
                <option value="blue-gold" ${state.settings.theme==="blue-gold"?"selected":""}>أزرق وذهبي</option>
                <option value="light" ${state.settings.theme==="light"?"selected":""}>فاتح</option>
                <option value="dark" ${state.settings.theme==="dark"?"selected":""}>داكن</option>
              </select>
              <button id="btnResetAll" class="px-3 py-2 rounded-xl border ${t.resetBtn}">
                🔄 إعادة ضبط اليوم
              </button>
            </div>
          </header>

          <div class="grid md:grid-cols-3 gap-4 mb-6">
            <div class="rounded-2xl shadow-sm border p-4 ${t.card}">
              <div class="text-sm opacity-70">إنجاز اليوم</div>
              <div class="text-3xl font-extrabold">${percent}%</div>
              <div class="mt-2">
                <div class="w-full h-3 bg-gray-200 rounded-xl overflow-hidden"><div class="h-full bg-green-600" style="width:${percent}%;"></div></div>
              </div>
            </div>
            <div class="rounded-2xl shadow-sm border p-4 ${t.card}">
              <div class="text-sm opacity-70 mb-1">اختصارات</div>
              <div class="text-sm opacity-90">اختر صفحة اليوم (1–604) وستتولد المراجعة والتحضير تلقائيًا.</div>
            </div>
            <div class="rounded-2xl shadow-sm border p-4 ${t.card}">
              <div class="text-sm opacity-70 mb-1">تلميح مدني</div>
              <div class="text-sm opacity-90">اختر جزءًا لعرض نطاق صفحاته (مدني).</div>
            </div>
          </div>

          <div class="mb-6 rounded-2xl shadow-sm border p-4 ${t.card}">
            <h2 class="text-xl font-bold mb-3">مهام اليوم</h2>
            <ul class="space-y-3" id="taskList"></ul>
          </div>
        </div>
      `;

      // Build tasks list
      const ul = root.querySelector("#taskList");
      function animClass(id, done) {
        if (!state._rowAnim[id]) state._rowAnim[id] = false;
        if (done && !state._rowAnim[id]) {
          state._rowAnim[id] = true;
          return "row-animated";
        }
        if (!done) state._rowAnim[id] = false;
        return "";
      }

      const row = (opts) => {
        const { id, label, extraHTML="", enabled=true, done=false, hasCounter=false, count=0, target=DEFAULT_READS_FOR_PREP } = opts;
        const faded = (!enabled) ? "opacity-50" : "";
        const rowClass = done ? `${t.rowDone} ${animClass(id, done)}` : t.rowActive;
        const checkMark = done ? `<span class="mr-2 ${t.checkIcon} text-xl">✔️</span>` : "";
        const li = el(`
          <li class="p-3 rounded-xl border flex flex-col ${rowClass} ${faded}">
            <div class="flex items-center gap-3">
              ${checkMark}
              <span class="font-medium">${label}</span>
              ${extraHTML}
            </div>
            ${hasCounter ? `
              <div class="flex items-center gap-2 mt-2">
                <button data-dec="${id}" ${!enabled?"disabled":""} class="p-1 rounded border ${t.button} ${!enabled?"opacity-60 cursor-not-allowed":""}">−</button>
                <div class="tabular-nums">${count} / ${target}</div>
                <button data-inc="${id}" ${!enabled?"disabled":""} class="p-1 rounded border ${t.button} ${!enabled?"opacity-60 cursor-not-allowed":""}">+</button>
              </div>
            `:``}
            <button data-toggle="${id}" ${!enabled?"disabled":""}
              class="mt-2 px-3 py-1 rounded border ${t.button} ${done?t.rowDone:""} ${!enabled?"opacity-60 cursor-not-allowed":""}">
              ${done ? "✓ تم" : "إنهاء"}
            </button>
          </li>
        `);
        ul.appendChild(li);
      };

      // قراءة الجزء اليومي
      const juzExtra = `
        <div class="flex flex-col gap-1">
          <input id="inpReadJuz" type="number" min="1" max="30" value="${state.day.readJuz.juz??""}"
                 class="border px-2 py-1 rounded ${t.input} w-24 text-center" />
          <small class="opacity-70">${state.day.readJuz.juz ? `الجزء ${state.day.readJuz.juz} — الصفحات ${juzSpan(state.day.readJuz.juz).start}–${juzSpan(state.day.readJuz.juz).end}` :""}
          </small>
        </div>`;
      row({ id:"readJuz", label:"قراءة الجزء اليومي", extraHTML:juzExtra, enabled:true, done: state.day.readJuz.done });

      // حفظ صفحة اليوم (sets todayPage)
      const memExtra = `
        <input id="inpTodayPage" type="number" min="1" max="604" placeholder="1–604" value="${state.todayPage??""}"
               class="border px-2 py-1 rounded ${t.input} w-24 text-center" />`;
      row({ id:"memorizeToday", label:"حفظ صفحة اليوم", extraHTML:memExtra, enabled:true, done: state.day.memorizeToday.done });

      // Derived tasks (need todayPage)
      const enabledDerived = hasPage();

      // مراجعة الصفحات السابقة
      row({
        id:"reviewLast7",
        label: enabledDerived ? `مراجعة الصفحات: ${prev7().join("، ")}` : "مراجعة الصفحات السابقة (اختر صفحة أولاً)",
        enabled: enabledDerived,
        done: state.day.reviewLast7.done
      });

      // تحضير الصفحات القادمة
      row({
        id:"prepNext7",
        label: enabledDerived ? `تحضير الصفحات: ${next7().join("، ")}` : "تحضير الصفحات القادمة (اختر صفحة أولاً)",
        enabled: enabledDerived,
        done: state.day.prepNext7.done
      });

      // تهيئة صفحة الغد (counter, always target 10)
      row({
        id:"prepTomorrow",
        label: enabledDerived ? `تهيئة صفحة الغد (${tomorrowPage()}) (10 مرات)` : "تهيئة صفحة الغد (اختر صفحة أولاً)",
        enabled: enabledDerived,
        done: state.day.prepTomorrow.done || (state.day.prepTomorrow.count >= DEFAULT_READS_FOR_PREP),
        hasCounter: true,
        count: state.day.prepTomorrow.count,
        target: DEFAULT_READS_FOR_PREP
      });

      // مراجعة الصفحات الحديثة (20)
      row({
        id:"reviewRecent20",
        label: enabledDerived ? `مراجعة الصفحات الحديثة (20): ${recent20().join("، ")}` : "مراجعة الصفحات الحديثة (اختر صفحة أولاً)",
        enabled: enabledDerived,
        done: state.day.reviewRecent20.done
      });

      // مراجعة جزء قديم
      const oldExtra = `
        <div class="flex flex-col gap-1">
          <input id="inpOldJuz" type="number" min="1" max="30" value="${state.day.reviewOldJuz.juz??""}"
                 class="border px-2 py-1 rounded ${t.input} w-24 text-center" />
          <small class="opacity-70">${state.day.reviewOldJuz.juz ? `الجزء ${state.day.reviewOldJuz.juz} — الصفحات ${juzSpan(state.day.reviewOldJuz.juz).start}–${juzSpan(state.day.reviewOldJuz.juz).end}` :""}
          </small>
        </div>`;
      row({ id:"reviewOldJuz", label:"مراجعة جزء قديم", extraHTML:oldExtra, enabled:true, done: state.day.reviewOldJuz.done });

      // السبع المنجيات (7 subtoggles)
      const sabWrap = el(`
        <li class="p-3 rounded-xl border flex flex-col ${themeClasses(state.settings.theme).rowActive}">
          <div class="flex flex-col gap-2">
            <div class="font-medium">قراءة السبع المنجيات</div>
            <div class="flex flex-wrap gap-2" id="sabChips"></div>
          </div>
        </li>
      `);
      const sabHolder = sabWrap.querySelector("#sabChips");
      SAB7.forEach((name, idx) => {
        const checked = !!state.day.sabAlMunajiyat.subs[idx];
        const chip = el(`
          <label class="inline-flex items-center gap-1 px-3 py-1 rounded-xl border ${themeClasses(state.settings.theme).button} ${checked? themeClasses(state.settings.theme).chipOn : ""} cursor-pointer select-none">
            <input type="checkbox" class="sr-only">
            <span class="ml-1">${name}</span>
            ${checked? `<span class="${themeClasses(state.settings.theme).checkIcon}">✔️</span>` : ``}
          </label>
        `);
        chip.querySelector("input").checked = checked;
        chip.addEventListener("change", () => {
          state.day.sabAlMunajiyat.subs[idx] = !state.day.sabAlMunajiyat.subs[idx];
          render();
        });
        sabHolder.appendChild(chip);
      });
      ul.appendChild(sabWrap);

      // Wire up theme select
      root.querySelector("#selTheme").onchange = e => {
        state.settings.theme = e.target.value;
        render();
      };

      // Wire up reset button
      root.querySelector("#btnResetAll").onclick = () => {
        // Reset all tasks
        state.day.readJuz.done = false;
        state.day.readJuz.juz = null;
        state.day.memorizeToday.done = false;
        state.todayPage = null;
        state.day.reviewLast7.done = false;
        state.day.prepNext7.done = false;
        state.day.prepTomorrow.done = false;
        state.day.prepTomorrow.count = 0;
        state.day.reviewRecent20.done = false;
        state.day.reviewOldJuz.done = false;
        state.day.reviewOldJuz.juz = null;
        state.day.sabAlMunajiyat.subs = {};
        render();
      };

      // Field inputs
      const inpReadJuz = root.querySelector("#inpReadJuz");
      if (inpReadJuz) inpReadJuz.oninput = (e) => {
        const v = e.target.value === "" ? null : clamp(parseInt(e.target.value,10)||0, 1, 30);
        state.day.readJuz.juz = v;
        render();
      };
      const inpTodayPage = root.querySelector("#inpTodayPage");
      if (inpTodayPage) inpTodayPage.oninput = (e) => {
        const v = e.target.value === "" ? null : clamp(parseInt(e.target.value,10)||0, 1, 604);
        state.todayPage = v;
        state.day.reviewLast7.done = false;
        state.day.prepNext7.done = false;
        state.day.prepTomorrow.done = false;
        state.day.prepTomorrow.count = 0;
        state.day.reviewRecent20.done = false;
        render();
      };
      const inpOldJuz = root.querySelector("#inpOldJuz");
      if (inpOldJuz) inpOldJuz.oninput = (e) => {
        const v = e.target.value === "" ? null : clamp(parseInt(e.target.value,10)||0, 1, 30);
        state.day.reviewOldJuz.juz = v;
        render();
      };

      // Toggles
      root.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const id = e.currentTarget.getAttribute("data-toggle");
          if ((id==="reviewLast7"||id==="prepNext7"||id==="prepTomorrow"||id==="reviewRecent20") && !hasPage()) return;
          state.day[id].done = !state.day[id].done;
          render();
        });
      });

      // Counters
      root.querySelectorAll("[data-dec]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          const id = e.currentTarget.getAttribute("data-dec");
          if (id==="prepTomorrow" && !hasPage()) return;
          state.day[id].count = clamp((state.day[id].count||0)-1, 0, DEFAULT_READS_FOR_PREP);
          render();
        });
      });
      root.querySelectorAll("[data-inc]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          const id = e.currentTarget.getAttribute("data-inc");
          if (id==="prepTomorrow" && !hasPage()) return;
          state.day[id].count = clamp((state.day[id].count||0)+1, 0, DEFAULT_READS_FOR_PREP);
          if (id==="prepTomorrow" && state.day.prepTomorrow.count >= DEFAULT_READS_FOR_PREP) {
            state.day.prepTomorrow.done = true;
          }
          render();
        });
      });
    }

    // Initial render
    render();
  </script>
</body>
</html>
