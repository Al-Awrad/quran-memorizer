<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>برنامج الحفظ اليومي للقرآن</title>
  <!-- Tailwind CDN (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind: nothing fancy, we’ll safelist classes by rendering them once in a hidden node below.
    tailwind.config = { theme: { extend: {} } };
  </script>
  <style>
    /* Small helper for visually-hidden inputs */
    .sr-only { position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0; }
    .tabular-nums { font-variant-numeric: tabular-nums; }
    /* Animation for marking as done */
    .row-animated {
      transition: background 0.3s, border-color 0.3s, transform 0.3s;
      animation: scaleUpFade 0.4s;
    }
    @keyframes scaleUpFade {
      0%   { transform: scale(0.97); opacity: 0.7;}
      60%  { transform: scale(1.05); opacity: 1;}
      100% { transform: scale(1); opacity: 1;}
    }
  </style>
</head>
<body>
  <!-- Safelist all theme classes so Tailwind CDN includes them -->
  <div class="hidden
    bg-[#FAFAFA] text-[#222] border-[#E0E0E0] bg-white
    bg-[#18181B] text-[#EEE] border-[#444] bg-[#23232A]
    bg-green-100 border-green-400 text-green-900
    bg-emerald-700/30 border-emerald-400 text-emerald-100
    bg-green-200 text-green-900
    bg-white border-gray-200 text-gray-800
    bg-[#23232A] border-[#444] text-[#EEE]
    border-green-400 text-green-500
    border-emerald-400 text-emerald-400
    hover:bg-[#F0F0F0] hover:bg-[#333]
  "></div>

  <div id="app" class="min-h-screen w-full"></div>

  <script>
    // ===================== Helpers & Constants =====================
    const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
    const wrap604 = (n) => (((n - 1) % 604) + 604) % 604 + 1;
    const JUZ_START_PAGES = [
      1, 22, 42, 62, 82, 102, 121, 142, 162, 182,
      201, 222, 242, 262, 282, 302, 322, 342, 362, 382,
      402, 422, 442, 462, 482, 502, 522, 542, 562, 582,
    ];
    const juzSpan = (j) => {
      const start = JUZ_START_PAGES[j - 1];
      const end = j === 30 ? 604 : JUZ_START_PAGES[j] - 1;
      return { start, end };
    };
    const SAB7 = ["السجدة","يس","الدخان","الواقعة","الملك","الإنسان","البروج"];

    // Themes (class tokens) - Only 2 themes: light & dark
    function themeClasses(theme) {
      switch (theme) {
        case "dark":
          return {
            page: "bg-[#18181B] text-[#EEE]",
            card: "border-[#444] bg-[#23232A]",
            input: "bg-[#23232A] text-[#EEE] border-[#444]",
            button: "border-[#444] hover:bg-[#333]",
            rowDone: "bg-emerald-700/30 border-emerald-400 text-emerald-100 row-animated",
            rowActive: "bg-[#23232A] border-[#444] text-[#EEE]",
            chipOn: "bg-emerald-700 text-emerald-100 border-emerald-400",
            checkIcon: "text-emerald-400",
          };
        default: // light
          return {
            page: "bg-[#FAFAFA] text-[#222]",
            card: "border-[#E0E0E0] bg-white",
            input: "bg-white text-[#222] border-[#E0E0E0]",
            button: "border-[#E0E0E0] hover:bg-[#F0F0F0]",
            rowDone: "bg-green-100 border-green-400 text-green-900 row-animated",
            rowActive: "bg-white border-gray-200 text-gray-800",
            chipOn: "bg-green-200 text-green-900 border-green-400",
            checkIcon: "text-green-500",
          };
      }
    }

    // ===================== Ephemeral State (no persistence) =====================
    const state = {
      settings: { theme: "light", targetReadsForPrep: 3 },
      todayPage: null, // 1..604
      day: {
        readJuz: { juz: null, done: false },
        memorizeToday: { done: false },
        reviewLast7: { done: false },
        prepNext7: { done: false },
        prepTomorrow: { count: 0, done: false }, // done if count >= target
        reviewRecent20: { done: false },
        reviewOldJuz: { juz: null, done: false },
        sabAlMunajiyat: { subs: {} }, // indices 0..6 true/false
      },
      _rowAnim: {}, // Track which rows were just completed for animation
    };

    // ===================== Derived Windows =====================
    function hasPage() {
      return Number.isInteger(state.todayPage) && state.todayPage >= 1 && state.todayPage <= 604;
    }
    function prev7() {
      if (!hasPage()) return [];
      return Array.from({length:7}, (_,i)=> wrap604(state.todayPage - 7 + i));
    }
    function next7() {
      if (!hasPage()) return [];
      return Array.from({length:7}, (_,i)=> wrap604(state.todayPage + 1 + i));
    }
    function tomorrowPage() {
      return hasPage() ? wrap604(state.todayPage + 1) : null;
    }
    function recent20() {
      if (!hasPage()) return [];
      return Array.from({length:20}, (_,i)=> wrap604(state.todayPage - 19 + i));
    }

    // ===================== Progress =====================
    function completionCounts() {
      const enabledTasks = [];
      const addTask = (id, count=1) => { enabledTasks.push({id, count}); };
      addTask("readJuz");
      addTask("memorizeToday");
      if (hasPage()) {
        addTask("reviewLast7");
        addTask("prepNext7");
        addTask("prepTomorrow");
        addTask("reviewRecent20");
      }
      addTask("reviewOldJuz");
      addTask("sabAlMunajiyat", 7); // 7 subtasks

      let total=0, done=0;
      for (const t of enabledTasks) {
        if (t.id === "sabAlMunajiyat") {
          total += 7;
          for (let i=0;i<7;i++) if (state.day.sabAlMunajiyat.subs[i]) done += 1;
        } else if (t.id === "prepTomorrow") {
          total += 1;
          done += (state.day.prepTomorrow.done || state.day.prepTomorrow.count >= state.settings.targetReadsForPrep) ? 1 : 0;
        } else {
          total += 1;
          done += state.day[t.id].done ? 1 : 0;
        }
      }
      return { total, done, percent: total ? Math.round(done/total*100) : 0 };
    }

    // ===================== Render =====================
    const root = document.getElementById("app");

    function el(html) {
      const t = document.createElement("template");
      t.innerHTML = html.trim();
      return t.content.firstElementChild;
    }

    function render() {
      const t = themeClasses(state.settings.theme);
      const { total, done, percent } = completionCounts();

      root.className = `${t.page}`;
      root.innerHTML = `
        <div class="max-w-4xl mx-auto p-4 sm:p-6">
          <header class="flex items-center justify-between gap-3 mb-4">
            <div>
              <h1 class="text-2xl sm:text-3xl font-bold">برنامج الحفظ اليومي للقرآن</h1>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnSettings" class="px-3 py-2 rounded-xl border ${t.button}">
                ⚙️ <span class="mr-1">إعدادات</span>
              </button>
            </div>
          </header>

          <div class="grid md:grid-cols-3 gap-4 mb-6">
            <div class="rounded-2xl shadow-sm border p-4 ${t.card}">
              <div class="text-sm opacity-70">إنجاز اليوم</div>
              <div class="text-3xl font-extrabold">${percent}%</div>
              <div class="mt-2">
                <div class="w-full h-3 bg-gray-200 rounded-xl overflow-hidden"><div class="h-full bg-green-600" style="width:${percent}%;"></div></div>
              </div>
            </div>
            <div class="rounded-2xl shadow-sm border p-4 ${t.card}">
              <div class="text-sm opacity-70 mb-1">اختصارات</div>
              <div class="text-sm opacity-90">اختر صفحة اليوم (1–604) وستتولد المراجعة والتحضير تلقائيًا.</div>
            </div>
            <div class="rounded-2xl shadow-sm border p-4 ${t.card}">
              <div class="text-sm opacity-70 mb-1">تلميح مدني</div>
              <div class="text-sm opacity-90">اختر جزءًا لعرض نطاق صفحاته (مدني).</div>
            </div>
          </div>

          <div class="mb-6 rounded-2xl shadow-sm border p-4 ${t.card}">
            <h2 class="text-xl font-bold mb-3">مهام اليوم</h2>
            <ul class="space-y-3" id="taskList"></ul>
          </div>
        </div>

        <!-- Settings modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center p-4">
          <div class="w-full max-w-xl rounded-2xl p-5 border ${t.card}">
            <h2 class="text-xl font-bold mb-4">إعدادات</h2>
            <label class="flex flex-col gap-1 mb-3">
              <span>عدد مرات قراءة صفحة الغد (3–10)</span>
              <input id="inpTarget" type="number" min="3" max="10" value="${state.settings.targetReadsForPrep}"
                     class="rounded-xl px-3 py-2 border ${t.input}" />
            </label>
            <label class="flex flex-col gap-1 mb-4">
              <span>السِمَة</span>
              <select id="selTheme" class="rounded-xl px-3 py-2 border ${t.input}">
                <option value="light" ${state.settings.theme==="light"?"selected":""}>فاتح</option>
                <option value="dark" ${state.settings.theme==="dark"?"selected":""}>داكن</option>
              </select>
            </label>
            <div class="flex gap-2">
              <button id="btnClose" class="px-4 py-2 rounded-xl border ${t.button}">تم</button>
            </div>
          </div>
        </div>
      `;

      // Build tasks list
      const ul = root.querySelector("#taskList");

      // Track animation: if a row just transitioned to done, mark for animation
      function animClass(id, done) {
        // If row just became done, set animation for this render
        if (!state._rowAnim[id]) state._rowAnim[id] = false;
        if (done && !state._rowAnim[id]) {
          state._rowAnim[id] = true;
          return "row-animated";
        }
        if (!done) state._rowAnim[id] = false;
        return "";
      }

      // Helpers to draw rows
      const row = (opts) => {
        const { id, label, extraHTML="", enabled=true, done=false, hasCounter=false, count=0, target=3 } = opts;
        const faded = (!enabled) ? "opacity-50" : "";
        const rowClass = done ? `${t.rowDone} ${animClass(id, done)}` : t.rowActive;
        const checkMark = done ? `<span class="mr-2 ${t.checkIcon} text-xl">✔️</span>` : "";
        const li = el(`
          <li class="p-3 rounded-xl border flex flex-col ${rowClass} ${faded}">
            <div class="flex items-center gap-3">
              ${checkMark}
              <span class="font-medium">${label}</span>
              ${extraHTML}
            </div>
            ${hasCounter ? `
              <div class="flex items-center gap-2 mt-2">
                <button data-dec="${id}" ${!enabled?"disabled":""} class="p-1 rounded border ${t.button} ${!enabled?"opacity-60 cursor-not-allowed":""}">−</button>
                <div class="tabular-nums">${count} / ${target}</div>
                <button data-inc="${id}" ${!enabled?"disabled":""} class="p-1 rounded border ${t.button} ${!enabled?"opacity-60 cursor-not-allowed":""}">+</button>
              </div>
            `:``}
            <button data-toggle="${id}" ${!enabled?"disabled":""}
              class="mt-2 px-3 py-1 rounded border ${t.button} ${done?t.rowDone:""} ${!enabled?"opacity-60 cursor-not-allowed":""}">
              ${done ? "✓ تم" : "إنهاء"}
            </button>
          </li>
        `);
        ul.appendChild(li);
      };

      // قراءة الجزء اليومي
      const juzExtra = `
        <div class="flex flex-col gap-1">
          <input id="inpReadJuz" type="number" min="1" max="30" value="${state.day.readJuz.juz??""}"
                 class="border px-2 py-1 rounded ${t.input} w-24 text-center" />
          <small class="opacity-70">${state.day.readJuz.juz ? `الجزء ${state.day.readJuz.juz} — الصفحات ${juzSpan(state.day.readJuz.juz).start}–${juzSpan(state.day.readJuz.juz).end}` :""}
          </small>
        </div>`;
      row({ id:"readJuz", label:"قراءة الجزء اليومي", extraHTML:juzExtra, enabled:true, done: state.day.readJuz.done });

      // حفظ صفحة اليوم (sets todayPage)
      const memExtra = `
        <input id="inpTodayPage" type="number" min="1" max="604" placeholder="1–604" value="${state.todayPage??""}"
               class="border px-2 py-1 rounded ${t.input} w-24 text-center" />`;
      row({ id:"memorizeToday", label:"حفظ صفحة اليوم", extraHTML:memExtra, enabled:true, done: state.day.memorizeToday.done });

      // Derived tasks (need todayPage)
      const enabledDerived = hasPage();

      // مراجعة الصفحات السابقة
      row({
        id:"reviewLast7",
        label: enabledDerived ? `مراجعة الصفحات: ${prev7().join("، ")}` : "مراجعة الصفحات السابقة (اختر صفحة أولاً)",
        enabled: enabledDerived,
        done: state.day.reviewLast7.done
      });

      // تحضير الصفحات القادمة
      row({
        id:"prepNext7",
        label: enabledDerived ? `تحضير الصفحات: ${next7().join("، ")}` : "تحضير الصفحات القادمة (اختر صفحة أولاً)",
        enabled: enabledDerived,
        done: state.day.prepNext7.done
      });

      // تهيئة صفحة الغد (counter)
      row({
        id:"prepTomorrow",
        label: enabledDerived ? `تهيئة صفحة الغد (${tomorrowPage()}) (3–10 مرات)` : "تهيئة صفحة الغد (اختر صفحة أولاً)",
        enabled: enabledDerived,
        done: state.day.prepTomorrow.done || (state.day.prepTomorrow.count >= state.settings.targetReadsForPrep),
        hasCounter: true,
        count: state.day.prepTomorrow.count,
        target: state.settings.targetReadsForPrep
      });

      // مراجعة الصفحات الحديثة (20)
      row({
        id:"reviewRecent20",
        label: enabledDerived ? `مراجعة الصفحات الحديثة (20): ${recent20().join("، ")}` : "مراجعة الصفحات الحديثة (اختر صفحة أولاً)",
        enabled: enabledDerived,
        done: state.day.reviewRecent20.done
      });

      // مراجعة جزء قديم
      const oldExtra = `
        <div class="flex flex-col gap-1">
          <input id="inpOldJuz" type="number" min="1" max="30" value="${state.day.reviewOldJuz.juz??""}"
                 class="border px-2 py-1 rounded ${t.input} w-24 text-center" />
          <small class="opacity-70">${state.day.reviewOldJuz.juz ? `الجزء ${state.day.reviewOldJuz.juz} — الصفحات ${juzSpan(state.day.reviewOldJuz.juz).start}–${juzSpan(state.day.reviewOldJuz.juz).end}` :""}
          </small>
        </div>`;
      row({ id:"reviewOldJuz", label:"مراجعة جزء قديم", extraHTML:oldExtra, enabled:true, done: state.day.reviewOldJuz.done });

      // السبع المنجيات (7 subtoggles)
      const sabWrap = el(`
        <li class="p-3 rounded-xl border flex flex-col ${themeClasses(state.settings.theme).rowActive}">
          <div class="flex flex-col gap-2">
            <div class="font-medium">قراءة السبع المنجيات</div>
            <div class="flex flex-wrap gap-2" id="sabChips"></div>
            <div>
              <button id="sabReset" class="text-xs underline opacity-80">إعادة ضبط اختيارات اليوم</button>
            </div>
          </div>
        </li>
      `);
      const sabHolder = sabWrap.querySelector("#sabChips");
      SAB7.forEach((name, idx) => {
        const checked = !!state.day.sabAlMunajiyat.subs[idx];
        const chip = el(`
          <label class="inline-flex items-center gap-1 px-3 py-1 rounded-xl border ${themeClasses(state.settings.theme).button} ${checked? themeClasses(state.settings.theme).chipOn : ""} cursor-pointer select-none">
            <input type="checkbox" class="sr-only">
            <span class="ml-1">${name}</span>
            ${checked? `<span class="${themeClasses(state.settings.theme).checkIcon}">✔️</span>` : ``}
          </label>
        `);
        chip.querySelector("input").checked = checked;
        chip.addEventListener("change", () => {
          state.day.sabAlMunajiyat.subs[idx] = !state.day.sabAlMunajiyat.subs[idx];
          render();
        });
        sabHolder.appendChild(chip);
      });
      ul.appendChild(sabWrap);

      // ===== Wire up inputs & buttons =====
      // Settings
      root.querySelector("#btnSettings").onclick = () => {
        const m = root.querySelector("#modal");
        m.classList.remove("hidden");
        m.classList.add("flex");
      };
      const modal = root.querySelector("#modal");
      if (modal) {
        modal.querySelector("#btnClose").onclick = () => {
          const target = clamp(parseInt(modal.querySelector("#inpTarget").value || "3", 10), 3, 10);
          const theme = modal.querySelector("#selTheme").value;
          state.settings.targetReadsForPrep = target;
          state.settings.theme = theme;
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          render();
        };
      }

      // Field inputs
      const inpReadJuz = root.querySelector("#inpReadJuz");
      if (inpReadJuz) inpReadJuz.oninput = (e) => {
        const v = e.target.value === "" ? null : clamp(parseInt(e.target.value,10)||0, 1, 30);
        state.day.readJuz.juz = v;
        render();
      };
      const inpTodayPage = root.querySelector("#inpTodayPage");
      if (inpTodayPage) inpTodayPage.oninput = (e) => {
        const v = e.target.value === "" ? null : clamp(parseInt(e.target.value,10)||0, 1, 604);
        state.todayPage = v;
        // Reset derived row finishes when page changes
        state.day.reviewLast7.done = false;
        state.day.prepNext7.done = false;
        state.day.prepTomorrow.done = false;
        state.day.prepTomorrow.count = 0;
        state.day.reviewRecent20.done = false;
        render();
      };
      const inpOldJuz = root.querySelector("#inpOldJuz");
      if (inpOldJuz) inpOldJuz.oninput = (e) => {
        const v = e.target.value === "" ? null : clamp(parseInt(e.target.value,10)||0, 1, 30);
        state.day.reviewOldJuz.juz = v;
        render();
      };

      // Toggles
      root.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const id = e.currentTarget.getAttribute("data-toggle");
          // Ignore clicks if the row is effectively disabled by page requirement
          if ((id==="reviewLast7"||id==="prepNext7"||id==="prepTomorrow"||id==="reviewRecent20") && !hasPage()) return;
          state.day[id].done = !state.day[id].done;
          render();
        });
      });

      // Counters
      root.querySelectorAll("[data-dec]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          const id = e.currentTarget.getAttribute("data-dec");
          if (id==="prepTomorrow" && !hasPage()) return;
          state.day[id].count = clamp((state.day[id].count||0)-1, 0, 10);
          render();
        });
      });
      root.querySelectorAll("[data-inc]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          const id = e.currentTarget.getAttribute("data-inc");
          if (id==="prepTomorrow" && !hasPage()) return;
          state.day[id].count = clamp((state.day[id].count||0)+1, 0, 10);
          // auto mark done if reached target
          if (id==="prepTomorrow" && state.day.prepTomorrow.count >= state.settings.targetReadsForPrep) {
            state.day.prepTomorrow.done = true;
          }
          render();
        });
      });

      // Sab reset
      const sabReset = root.querySelector("#sabReset");
      if (sabReset) sabReset.onclick = () => { state.day.sabAlMunajiyat.subs = {}; render(); };
    }

    // Initial render
    render();
  </script>
</body>
</html>
